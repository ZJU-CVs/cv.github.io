---
layout:     post
title:      Docker管理服务器
subtitle:   随时更新...
date:       2020-11-18
author:     JY
header-img: img/post-bg.jpg
catalog: true
tags:
    - Tools
---



##### 容器启动

```bash

docker pull registry.example.net:5000/env:1.0
docker tag registry.example.net:5000/env:1.0 env:1.0

nvidia-docker run --name env -itd -p 88:8888 -p 2222:22 -v /data0/JY:/data0/JY env:1.0 /bin/zsh

# env2.0 with conda and vnc
docker pull registry.example.net:5000/env:2.0
docker tag registry.example.net:5000/env:2.0 env:2.0
nvidia-docker run --name env -itd -p 99:9999 -p 88:8888 -p 2222:22 -p 6901:5901 -v /data0:/data0 env:2.0  /bin/zsh
# -p 99:9999 备用IP端口
# -p 88:88 jupyter notebook端口
# -p 2222:22   ssh远程连接端口
# -p 6901:5901 vnc远程桌面端口

nvidia-docker exec -it env /bin/zsh
```



##### 修改配置

方法一：不推荐

```bash 
# 容器的配置文件路径
sudo service docker stop  # 这一步是必需的

/var/lib/docker/containers/[hash_of_the_container]/hostconfig.json  # 可能需要管理员 su
# 可以通过docker ps或者docker inspect containername查看。（CONTAINER ID就可以看出来对应的hash_of_the_container）

# 修改.json文件
vim *.json  # 按下F4

sudo systemctl restart docker
```

```json
"Binds": ["/data0:/data0"],
"PortBindings": {
        "5901/tcp": [
            {
                "HostIp": "",
                "HostPort": "6901"
            }
        ]
    },

```

方法二：重新启动新的（推荐）

```markdown
step1: docker commit 容器名|容器id 新镜像名
step2: 重新run一个新容器
```



##### 基本安装

```
apt-get install vim wget git
sudo apt-get install zsh 
apt-get install iproute2 iproute2-doc inetutils-ping net-tools
chsh -s /bin/zsh
sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"
```



##### Anaconda安装

```bash
#修改镜像源
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/main
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/free
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/mro
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/msys2
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/pro
conda config --add channels https://anaconda.mirrors.sjtug.sjtu.edu.cn/pkgs/r
```



##### jupyter notebook配置

将docker的`8888`端口映射到`88`，连接为`hostIP:88`	

```bash 
jupyter notebook --ip=0.0.0.0 --allow-root  # 运行jupyter-notebook
# 界面： hostIP:88

# 安装nodejs，jupyterlab需要 
sudo apt-get update
sudo apt-get install -y software-properties-common
sudo add-apt-repository ppa:chris-lea/node.js
sudo apt-get install nodejs
sudo apt install libssl1.0-dev nodejs-dev node-gyp npm
```



##### vscode/pycharm连接

将docker的`22`端口映射到`2222`，连接为`hostIP:2222`	

```bash
# mkdir /var/run/sshd
echo 'root:amax' | chpasswd
sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
echo "export VISIBLE=now" >> /etc/profile
service ssh restart

# vscode连接
Host docker102
HostName 10.15.198.102
Port 22
User root
Password amax
```



##### VNC配置

将docker的`5901`端口映射到`6901`，连接为`hostIP:5901`

```bash
apt install xfce4 xfce4-goodies xrdp xbase-clients
apt install vnc4server 

vim ~/.vnc/xstartup
# 修改为如下： 
#!/bin/bash
xrdb $HOME/.Xresources
startxfce4 &

chmod +x ~/.vnc/xstartup
vncserver
```



